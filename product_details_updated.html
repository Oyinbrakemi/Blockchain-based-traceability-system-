<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Agricultural Traceability System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .back-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .product-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .product-id {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-harvested { background: #f39c12; color: white; }
        .status-processing { background: #e67e22; color: white; }
        .status-packaged { background: #3498db; color: white; }
        .status-shipped { background: #9b59b6; color: white; }
        .status-delivered { background: #27ae60; color: white; }
        .status-recalled { background: #e74c3c; color: white; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 18px;
        }

        .error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connected {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .disconnected {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .back-button {
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        üî¥ Not Connected
    </div>

    <div class="container">
        <div class="header">
            <h1>üåæ Product Details</h1>
            <button class="back-button" onclick="goBack()">‚Üê Back to Main</button>
        </div>
        
        <div id="loading" class="loading">
            Loading product details...
        </div>
        
        <div id="error" class="error" style="display: none;">
            Error loading product details. Please try again.
        </div>
        
        <div id="productDetails"></div>
    </div>

    <script>
        // Complete ABI for the smart contract
        const CONTRACT_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "uint256", "name": "batchId", "type": "uint256"},
                    {"indexed": false, "internalType": "uint256[]", "name": "productIds", "type": "uint256[]"}
                ],
                "name": "BatchCreated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "previousOwner", "type": "address"},
                    {"indexed": true, "internalType": "address", "name": "newOwner", "type": "address"}
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "uint256", "name": "productId", "type": "uint256"},
                    {"indexed": true, "internalType": "string", "name": "reason", "type": "string"}
                ],
                "name": "ProductRecalled",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "uint256", "name": "productId", "type": "uint256"},
                    {"indexed": true, "internalType": "address", "name": "farmer", "type": "address"},
                    {"indexed": false, "internalType": "string", "name": "name", "type": "string"}
                ],
                "name": "ProductRegistered",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "uint256", "name": "productId", "type": "uint256"},
                    {"indexed": false, "internalType": "enum AgriTraceability.ProductStatus", "name": "status", "type": "uint8"}
                ],
                "name": "ProductStatusUpdated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "uint256", "name": "productId", "type": "uint256"},
                    {"indexed": false, "internalType": "bool", "name": "passed", "type": "bool"}
                ],
                "name": "QualityTestAdded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "stakeholder", "type": "address"},
                    {"indexed": false, "internalType": "string", "name": "role", "type": "string"}
                ],
                "name": "StakeholderRegistered",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "uint256", "name": "productId", "type": "uint256"},
                    {"indexed": false, "internalType": "address", "name": "carrier", "type": "address"}
                ],
                "name": "TransportRecorded",
                "type": "event"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_productId", "type": "uint256"},
                    {"internalType": "string", "name": "_testType", "type": "string"},
                    {"internalType": "string", "name": "_results", "type": "string"},
                    {"internalType": "bool", "name": "_passed", "type": "bool"},
                    {"internalType": "string", "name": "_laboratoryName", "type": "string"}
                ],
                "name": "addQualityTest",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "_tester", "type": "address"}
                ],
                "name": "authorizeTester",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256[]", "name": "_productIds", "type": "uint256[]"},
                    {"internalType": "string", "name": "_processingFacility", "type": "string"},
                    {"internalType": "uint256", "name": "_expiryDate", "type": "uint256"},
                    {"internalType": "string", "name": "_packageType", "type": "string"},
                    {"internalType": "uint256", "name": "_quantity", "type": "uint256"}
                ],
                "name": "createBatch",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_productId", "type": "uint256"}
                ],
                "name": "completeTransport",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_productId", "type": "uint256"}
                ],
                "name": "getProduct",
                "outputs": [
                    {
                        "components": [
                            {"internalType": "uint256", "name": "id", "type": "uint256"},
                            {"internalType": "string", "name": "name", "type": "string"},
                            {"internalType": "string", "name": "variety", "type": "string"},
                            {"internalType": "string", "name": "origin", "type": "string"},
                            {"internalType": "address", "name": "farmer", "type": "address"},
                            {"internalType": "uint256", "name": "plantedDate", "type": "uint256"},
                            {"internalType": "uint256", "name": "harvestDate", "type": "uint256"},
                            {"internalType": "enum AgriTraceability.ProductStatus", "name": "status", "type": "uint8"},
                            {"internalType": "enum AgriTraceability.QualityGrade", "name": "grade", "type": "uint8"},
                            {"internalType": "bool", "name": "isOrganic", "type": "bool"},
                            {"internalType": "string[]", "name": "certifications", "type": "string[]"},
                            {"internalType": "uint256", "name": "batchId", "type": "uint256"}
                        ],
                        "internalType": "struct AgriTraceability.Product",
                        "name": "",
                        "type": "tuple"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_productId", "type": "uint256"}
                ],
                "name": "getQualityTests",
                "outputs": [
                    {
                        "components": [
                            {"internalType": "string", "name": "testType", "type": "string"},
                            {"internalType": "string", "name": "results", "type": "string"},
                            {"internalType": "bool", "name": "passed", "type": "bool"},
                            {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
                            {"internalType": "address", "name": "tester", "type": "address"},
                            {"internalType": "string", "name": "laboratoryName", "type": "string"}
                        ],
                        "internalType": "struct AgriTraceability.QualityTest[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_productId", "type": "uint256"}
                ],
                "name": "getTransportHistory",
                "outputs": [
                    {
                        "components": [
                            {"internalType": "string", "name": "vehicleId", "type": "string"},
                            {"internalType": "string", "name": "origin", "type": "string"},
                            {"internalType": "string", "name": "destination", "type": "string"},
                            {"internalType": "uint256", "name": "startTime", "type": "uint256"},
                            {"internalType": "uint256", "name": "endTime", "type": "uint256"},
                            {"internalType": "int256", "name": "temperature", "type": "int256"},
                            {"internalType": "uint256", "name": "humidity", "type": "uint256"},
                            {"internalType": "address", "name": "carrier", "type": "address"},
                            {"internalType": "bool", "name": "isCompleted", "type": "bool"}
                        ],
                        "internalType": "struct AgriTraceability.Transport[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "string", "name": "_name", "type": "string"},
                    {"internalType": "string", "name": "_variety", "type": "string"},
                    {"internalType": "string", "name": "_origin", "type": "string"},
                    {"internalType": "bool", "name": "_isOrganic", "type": "bool"},
                    {"internalType": "string[]", "name": "_certifications", "type": "string[]"}
                ],
                "name": "registerProduct",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "string", "name": "_role", "type": "string"}
                ],
                "name": "registerStakeholder",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_productId", "type": "uint256"},
                    {"internalType": "string", "name": "_vehicleId", "type": "string"},
                    {"internalType": "string", "name": "_origin", "type": "string"},
                    {"internalType": "string", "name": "_destination", "type": "string"},
                    {"internalType": "int256", "name": "_temperature", "type": "int256"},
                    {"internalType": "uint256", "name": "_humidity", "type": "uint256"}
                ],
                "name": "recordTransport",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_productId", "type": "uint256"},
                    {"internalType": "enum AgriTraceability.ProductStatus", "name": "_status", "type": "uint8"}
                ],
                "name": "updateProductStatus",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        let web3;
        let contract;
        let productId;
        let contractAddress;

        // Status mappings
        const STATUS_NAMES = {
            0: 'Harvested',
            1: 'Processing',
            2: 'Packaged',
            3: 'Shipped',
            4: 'Delivered',
            5: 'Recalled'
        };

        const GRADE_NAMES = {
            0: 'A',
            1: 'B',
            2: 'C'
        };

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = 'üü¢ Connected';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'üî¥ Not Connected';
                statusElement.className = 'connection-status disconnected';
            }
        }

        function goBack() {
            // Try to go back in history first
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // If no history, close the window/tab
                window.close();
            }
        }

        // Get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Initialize Web3 connection
        async function initWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    web3 = new Web3(window.ethereum);
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    contract = new web3.eth.Contract(CONTRACT_ABI, contractAddress);
                    updateConnectionStatus(true);
                    
                    // Now fetch the product details
                    await loadProductDetails();
                } catch (error) {
                    console.error('Error connecting to Web3:', error);
                    showError('Error connecting to Web3: ' + error.message);
                    updateConnectionStatus(false);
                }
            } else {
                showError('Please install MetaMask to view product details');
                updateConnectionStatus(false);
            }
        }

        // Load product details from blockchain
        async function loadProductDetails() {
            try {
                const product = await contract.methods.getProduct(productId).call();
                const qualityTests = await contract.methods.getQualityTests(productId).call();
                const transportHistory = await contract.methods.getTransportHistory(productId).call();

                document.getElementById('loading').style.display = 'none';
                displayProductDetails(product, qualityTests, transportHistory);
                
                // Update page title with product name
                document.title = `${product.name} - Product Details`;
            } catch (error) {
                console.error('Error loading product details:', error);
                showError('Error loading product details: ' + error.message);
            }
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function displayProductDetails(product, qualityTests, transportHistory) {
            const detailsDiv = document.getElementById('productDetails');
            
            const statusClass = `status-${STATUS_NAMES[product.status].toLowerCase()}`;
            
            let html = `
                <div class="product-card">
                    <div class="product-header">
                        <div class="product-id">ID: ${product.id}</div>
                        <div class="status-badge ${statusClass}">${STATUS_NAMES[product.status]}</div>
                    </div>
                    
                    <h3>${product.name} - ${product.variety}</h3>
                    
                    <div class="grid">
                        <div><strong>Origin:</strong> ${product.origin}</div>
                        <div><strong>Farmer:</strong> ${product.farmer}</div>
                        <div><strong>Organic:</strong> ${product.isOrganic ? 'Yes' : 'No'}</div>
                        <div><strong>Grade:</strong> ${GRADE_NAMES[product.grade]}</div>
                        <div><strong>Planted:</strong> ${product.plantedDate > 0 ? new Date(product.plantedDate * 1000).toLocaleDateString() : 'N/A'}</div>
                        <div><strong>Harvested:</strong> ${product.harvestDate > 0 ? new Date(product.harvestDate * 1000).toLocaleDateString() : 'N/A'}</div>
                    </div>
                    
                    ${product.certifications.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>Certifications:</strong> ${product.certifications.join(', ')}
                        </div>
                    ` : ''}
                    
                    ${product.batchId > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>Batch ID:</strong> ${product.batchId}
                        </div>
                    ` : ''}
                </div>
            `;

            // Quality Tests
            if (qualityTests.length > 0) {
                html += `
                    <div class="product-card">
                        <h3>Quality Tests</h3>
                        ${qualityTests.map(test => `
                            <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${test.passed ? '#27ae60' : '#e74c3c'}; background: rgba(0,0,0,0.05);">
                                <div><strong>Test:</strong> ${test.testType}</div>
                                <div><strong>Result:</strong> ${test.passed ? '‚úÖ Passed' : '‚ùå Failed'}</div>
                                <div><strong>Details:</strong> ${test.results}</div>
                                <div><strong>Laboratory:</strong> ${test.laboratoryName}</div>
                                <div><strong>Date:</strong> ${new Date(test.timestamp * 1000).toLocaleDateString()}</div>
                                <div><strong>Tester:</strong> ${test.tester}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Transport History
            if (transportHistory.length > 0) {
                html += `
                    <div class="product-card">
                        <h3>Transport History</h3>
                        ${transportHistory.map(transport => `
                            <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${transport.isCompleted ? '#27ae60' : '#f39c12'}; background: rgba(0,0,0,0.05);">
                                <div><strong>Vehicle:</strong> ${transport.vehicleId}</div>
                                <div><strong>Route:</strong> ${transport.origin} ‚Üí ${transport.destination}</div>
                                <div><strong>Status:</strong> ${transport.isCompleted ? '‚úÖ Completed' : 'üöõ In Transit'}</div>
                                <div><strong>Temperature:</strong> ${transport.temperature}¬∞C</div>
                                <div><strong>Humidity:</strong> ${transport.humidity}%</div>
                                <div><strong>Started:</strong> ${new Date(transport.startTime * 1000).toLocaleDateString()}</div>
                                ${transport.endTime > 0 ? `<div><strong>Completed:</strong> ${new Date(transport.endTime * 1000).toLocaleDateString()}</div>` : ''}
                                <div><strong>Carrier:</strong> ${transport.carrier}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            detailsDiv.innerHTML = html;
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            // Get parameters from URL
            productId = getUrlParameter('productId');
            contractAddress = getUrlParameter('contractAddress');
            
            if (!productId || !contractAddress) {
                showError('Missing product ID or contract address in URL parameters');
                return;
            }
            
            // Initialize Web3 and load product details
            initWeb3();
        });
    </script>
</body>
</html>